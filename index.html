<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aera Link</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon_io">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
    <link rel="shortcut icon" href="favicon_io/favicon-32x32.png">
    <link rel="apple-touch-icno, on" sizes="180x180" href="favicon_io/apple-touch-icon.png">
    <meta name="msapplication-TileImage" content="assets/AERA LOGO.png">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#00ffe7">
    
    <!-- Tailwind CSS (Development version) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Neon teal theme
                        'neon-teal': '#00ffe7',
                        'pure-black': '#121212',
                        'dark-gray': '#1a1a1a',
                        'light-gray': '#e0e0e0'
                    },
                    boxShadow: {
                        'neon-glow': '0 0 8px rgba(0, 255, 231, 0.6)',
                        'neon-glow-sm': '0 0 4px rgba(0, 255, 231, 0.4)',
                        'neon-glow-lg': '0 0 16px rgba(0, 255, 231, 0.8)'
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <!-- Legacy sidebar CSS removed - now using custom toolbox system -->
    
    <!-- Heroicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Avenir Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-pure-black text-light-gray overflow-hidden">
    <!-- Tauri API is automatically injected when withGlobalTauri is enabled -->
    
    <!-- Authentication Module -->
    <script src="js/authentication.js"></script>
    
    <!-- Collaborative Mode Module -->
    <script src="js/collaborative-mode.js"></script>
    
    <!-- Basemap Manager Module -->
    <script src="js/basemap-manager.js"></script>
    
    <!-- Filter System Module -->
    <script src="js/filter-system.js"></script>
    
    <!-- Selection Tools Module -->
    <script src="js/selection-tools.js"></script>
    
    <!-- Layer Manager Module -->
    <script src="js/layer-manager.js"></script>
    
    <!-- Symbology Editor Module -->
    <script src="js/symbology-editor.js"></script>

    <!-- Labels Module -->
    <script src="js/Labels.js"></script>

    <!-- Interaction Handlers Module -->
    <script src="js/interaction-handlers.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (window.map && typeof bindPopupHandlers === 'function') {
            bindPopupHandlers(window.map);
          }
        } catch (error) {
          console.error("Error in popup logic:", error);
        }
      });
    </script>
    
    <!-- Custom Confirmation Modal -->
    <div id="customModal" class="confirm-modal-overlay">
        <div class="confirm-modal">
            <div id="customModalIcon" class="confirm-modal-icon"></div>
            <div id="customModalTitle" class="confirm-modal-title">Confirm Action</div>
            <div id="customModalMessage" class="confirm-modal-message">
                Are you sure you want to continue?
            </div>
            <div id="customModalInput" class="confirm-modal-input-container" style="display: none;">
                <input type="text" id="customModalInputField" class="confirm-modal-input" placeholder="Enter value...">
            </div>
            <div id="customModalButtons" class="confirm-modal-buttons">
                <button id="customModalOkBtn" class="confirm-modal-btn confirm-modal-btn-ok">OK</button>
                <button id="customModalCancelBtn" class="confirm-modal-btn confirm-modal-btn-cancel" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Login Container -->
    <div id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">AÃ©ra Link</h1>
                <p class="login-subtitle">AKL Online Portal</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="Enter your email address"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <div class="password-input-container">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input has-toggle" 
                            placeholder="Enter your password"
                            required
                        >
                        <button type="button" class="password-toggle-btn" id="passwordToggle">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" id="loginButton" class="login-button">
                    Sign In to WebGIS
                </button>
                
                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Forgot your password?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- WebGIS Container -->
    <div id="webgisContainer" style="display: none;">
        <!-- Loading Animation -->
        <div id="layersLoadingOverlay" class="layers-loading-overlay">
            <div class="layers-loading-content">
                <div class="layers-loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <div class="layers-loading-text">
                    <h3>Fetching Layers</h3>
                    <p id="loadingProgress">Initializing</p>
                </div>
            </div>
        </div>
        
        <!-- Header -->
        <div class="header-container">
            <header class="bg-pure-black fixed top-0 left-0 right-0 z-50 px-4 py-2 h-10">
                <div class="flex items-center justify-between h-full">
                    <div class="flex items-center space-x-3">
                        <!-- Personal/Collaborative Mode Toggle -->
                        <div class="flex items-center space-x-2 bg-pure-black/80 backdrop-blur-sm px-3 py-1 rounded border border-neon-teal/30">
                            <span class="text-xs text-light-gray uppercase tracking-wide">Mode:</span>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-400" id="personalModeLabel">Personal</span>
                                <div class="relative">
                                    <input type="checkbox" id="collaborativeModeToggle" class="sr-only">
                                    <label for="collaborativeModeToggle" class="flex items-center cursor-pointer">
                                        <div class="w-8 h-4 bg-gray-700 rounded-full relative transition-colors duration-200 ease-in-out toggle-bg">
                                            <div class="w-3 h-3 bg-white rounded-full absolute top-0.5 left-0.5 transition-transform duration-200 ease-in-out toggle-thumb"></div>
                                        </div>
                                    </label>
                                </div>
                                <span class="text-xs text-gray-400" id="collaborativeModeLabel">Collaborative</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Centered Search Bar -->
                    <div class="flex-1 flex justify-center">
                        <div class="w-full max-w-md">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400 text-sm"></i>
                                </div>
                                <input type="text" id="headerSearchInput" class="w-full pl-10 pr-4 py-1.5 bg-pure-black/60 backdrop-blur-sm border border-neon-teal/30 rounded-full text-light-gray text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-neon-teal/50 focus:border-neon-teal transition-all" placeholder="Search...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- User Avatar and Logout -->
                    <div class="flex items-center space-x-3">
                        <div id="userAvatar" class="w-7 h-7 bg-neon-teal rounded-full flex items-center justify-center border border-white/20 cursor-pointer hover:shadow-neon-glow-sm transition-all">
                            <span id="userInitial" class="text-pure-black text-sm font-bold uppercase"></span>
                        </div>
                        <button id="logoutButton" class="text-light-gray hover:text-neon-teal transition-colors text-sm flex items-center space-x-1">
                            <i class="fas fa-sign-out-alt text-xs"></i>
                            <span class="hidden sm:inline"></span>
                        </button>
                    </div>
                </div>
            </header>
        </div>

    <!-- Modern Fixed Navigation Sidebar -->
    <div id="modernNavSidebar" class="modern-nav-sidebar expanded">
        
        <!-- Aera Logo at top of navbar -->
        <div class="nav-logo-container">
            <img src="assets/AERA LOGO.png" alt="Aera Logo" class="h-[40px] w-auto mx-auto">
        </div>
        
        <!-- Navigation Content -->
        <div class="nav-content">
            
            <!-- Navigation Links -->
            <nav class="nav-links">
                <div class="nav-item" data-section="dashboard" title="Dashboard">
                    <div class="nav-item-content">
                        <i class="fas fa-chart-line nav-item-icon"></i>
                        <span class="nav-item-text">Dashboard</span>
                    </div>
                </div>
                <div class="nav-item" data-section="map" title="Map">
                    <div class="nav-item-content">
                        <i class="fas fa-map nav-item-icon"></i>
                        <span class="nav-item-text">Map</span>
                    </div>
                </div>
                <div class="nav-item" data-section="database" title="Database">
                    <div class="nav-item-content">
                        <i class="fas fa-database nav-item-icon"></i>
                        <span class="nav-item-text">Database</span>
                    </div>
                </div>
                
                <!-- User Profile Section -->
                <div class="nav-user-profile">
                    <div class="nav-user-content">
                        <div class="nav-user-avatar">
                            <span id="navUserInitial" class="nav-user-initial"></span>
                        </div>
                        <div class="nav-user-info">
                            <span class="nav-user-name" id="navUserName">User</span>
                            <span class="nav-user-email" id="navUserEmail">user@email.com</span>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content-container">
        <!-- Dashboard Section -->
        <div id="dashboardSection" class="app-section" style="display: none;">
            <div class="section-content">
                <h1 class="page-title text-white font-bold mb-6">Dashboard</h1>
                <p class="text-light-gray">Dashboard interface coming soon...</p>
            </div>
        </div>

        <!-- Map Section -->
        <div id="mapSection" class="app-section active">
            <!-- Map Container -->
            <div id="map"></div>
        </div>

        <!-- Database Section -->
        <div id="databaseSection" class="app-section" style="display: none;">
            <div class="section-content">
                <h1 class="page-title text-white font-bold mb-6">Database</h1>
                <p class="text-light-gray">Database interface coming soon...</p>
            </div>
        </div>
        
        
        <!-- Floating Statistics Cards Container -->
        <div id="floatingStatisticsContainer" class="fixed top-24 right-2 sm:right-6 z-[1150] space-y-3 w-64 sm:w-72 lg:w-80 max-w-[90vw] max-h-[calc(100vh-8rem)] overflow-y-auto pr-2 sm:pr-0" style="display: none;">
            <!-- Statistics cards will be dynamically added here -->
        </div>
        
        <!-- Floating Toolbox (Right Edge) -->
        <div id="floatingToolbox" class="floating-toolbox">
            <div class="toolbox-buttons">
                <button class="tool-btn" data-tool="add-data" title="Add Data">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="tool-btn" data-tool="filter" title="Filter">
                    <i class="fas fa-filter"></i>
                </button>
                <button class="tool-btn" data-tool="layers" title="Layers">
                    <i class="fas fa-layer-group"></i>
                </button>
                <button class="tool-btn" data-tool="legend" title="Legend">
                    <i class="fas fa-list"></i>
                </button>
                <button class="tool-btn" data-tool="select" title="Select Features">
                    <i class="fas fa-draw-polygon"></i>
                </button>
                <button class="tool-btn" data-tool="labels" title="Label Tool">
                    <i class="fas fa-tag"></i>
                </button>
            </div>
        </div>

        <!-- Floating Toolbar Panels -->
        <div id="toolbarPanels" class="toolbar-panels-container">
            <!-- Add Data Panel -->
            <div class="toolbar-panel" id="add-data-panel" data-tool="add-data">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-plus text-neon-teal mr-2"></i>Add Data
                        </h1>
                    </div>
                    <div class="p-4 space-y-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <!-- Local File Upload Section -->
                        <div class="glass-section p-4">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    File Upload
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Upload GeoJSON, KML, KMZ, GPX, or CSV files from your computer.
                                </p>
                            </div>
                            <div class="flex flex-col gap-3">
                                <input type="file" id="fileInput" class="hidden" accept=".geojson,.json,.kml,.kmz,.gpx,.csv" multiple />
                                <button id="uploadFileBtn" class="w-full px-4 py-2 bg-neon-teal/20 hover:bg-neon-teal/30 border border-neon-teal/40 hover:border-neon-teal text-white rounded transition-all text-sm font-medium flex items-center justify-center hover:shadow-neon-glow-sm">
                                    <i class="fas fa-folder-open mr-2"></i>Choose Files
                                </button>
                                <div id="uploadFileList" class="text-sm text-light-gray mt-2 hidden">
                                    <div class="text-xs font-medium mb-1 text-neon-teal">Selected files:</div>
                                    <ul class="list-disc list-inside"></ul>
                                </div>
                            </div>
                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="mt-4 hidden">
                                <div class="flex justify-between text-xs text-light-gray mb-1">
                                    <span>Uploading...</span>
                                    <span id="uploadPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-800 rounded-full h-2 border border-neon-teal/20">
                                    <div id="uploadProgressBar" class="bg-neon-teal h-2 rounded-full transition-all duration-300 shadow-neon-glow-sm" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Web URL Section -->
                        <div class="glass-section p-4">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Web Data
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Enter a URL to load GeoJSON, KML, KMZ, GPX, or CSV data from the web.
                                </p>
                            </div>
                            <div class="flex flex-col gap-3">
                                <input type="url" id="webUrlInput" 
                                       class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal placeholder:text-gray-500"
                                       placeholder="https://services.arcgis.com/.../FeatureServer/0" />
                                    <div class="text-xs text-gray-400 mb-2">
                                        <i class="fas fa-info-circle mr-1 text-neon-teal"></i>
                                        Supports GeoJSON endpoints and ArcGIS REST service URLs (all features will be loaded via pagination)
                                    </div>
                                    <details class="text-xs text-gray-500">
                                        <summary class="cursor-pointer hover:text-neon-teal mb-1">Sample ArcGIS URLs for testing</summary>
                                        <div class="pl-2 space-y-1 text-xs font-mono">
                                            <div class="p-1 bg-gray-800 rounded cursor-pointer hover:bg-gray-700" onclick="document.getElementById('webUrlInput').value = this.textContent">
                                                https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Counties_Generalized/FeatureServer/0
                                            </div>
                                            <div class="p-1 bg-gray-800 rounded cursor-pointer hover:bg-gray-700" onclick="document.getElementById('webUrlInput').value = this.textContent">
                                                https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Major_Cities/FeatureServer/0
                                            </div>
                                        </div>
                                    </details>
                                    <button id="loadUrlBtn" class="w-full px-4 py-2 bg-neon-teal/20 hover:bg-neon-teal/30 border border-neon-teal/40 hover:border-neon-teal text-white rounded transition-all text-sm font-medium flex items-center justify-center hover:shadow-neon-glow-sm">
                                        <i class="fas fa-download mr-2"></i>Load from URL
                                    </button>
                            </div>
                            <!-- URL Load Progress -->
                            <div id="urlLoadProgress" class="mt-4 hidden">
                                <div class="flex justify-between text-xs text-gray-300 mb-1">
                                    <span id="urlLoadStatus">Loading...</span>
                                    <span id="urlLoadPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2 border border-neon-teal/20">
                                    <div id="urlLoadProgressBar" class="bg-neon-teal h-2 rounded-full transition-all duration-300 shadow-neon-glow-sm" style="width: 0%"></div>
                                </div>
                                <div id="urlLoadDetails" class="text-xs text-gray-400 mt-2 hidden">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-spinner fa-spin text-neon-teal"></i>
                                        <span id="paginationStatus">Fetching data...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Philippine Geoportal WMS Section -->
                        <div class="glass-section p-4">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Philippine Geoportal WMS
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Browse and add layers from the Philippine Geoportal WMS service.
                                </p>
                            </div>
                            <div class="flex flex-col gap-3">
                                <button id="loadWMSCapabilitiesBtn" class="w-full px-4 py-2 bg-neon-teal/20 hover:bg-neon-teal/30 border border-neon-teal/40 hover:border-neon-teal text-white rounded transition-all text-sm font-medium flex items-center justify-center hover:shadow-neon-glow-sm">
                                    <i class="fas fa-globe mr-2"></i>Browse WMS Layers
                                </button>
                                <button id="refreshWMSCapabilitiesBtn" class="w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 border border-gray-600 hover:border-gray-500 text-white rounded transition-all text-xs font-medium flex items-center justify-center hidden">
                                    <i class="fas fa-sync-alt mr-2"></i>Refresh Cache
                                </button>
                            </div>
                            
                            <!-- WMS Load Progress -->
                            <div id="wmsLoadProgress" class="mt-4 hidden">
                                <div class="flex justify-between text-xs text-gray-300 mb-1">
                                    <span id="wmsLoadStatus">Loading...</span>
                                    <span id="wmsLoadPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2 border border-neon-teal/20">
                                    <div id="wmsLoadProgressBar" class="bg-neon-teal h-2 rounded-full transition-all duration-300 shadow-neon-glow-sm" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- WMS Layers List Container -->
                            <div id="wmsLayersContainer" class="mt-4 hidden">
                                <div class="section-divider pb-2 mb-4">
                                    <h3 class="text-white font-semibold text-sm mb-2">
                                        <i class="fas fa-layer-group mr-2"></i>Available WMS Layers
                                    </h3>
                                    <p class="text-gray-400 text-xs">
                                        Select layers to add to your map. Use the search box to filter layers.
                                    </p>
                                </div>
                                <div id="wmsLayersList" class="space-y-4">
                                    <!-- WMS layers will be populated here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Supported Formats Info -->
                        <div class="glass-section p-4">
                            <h2 class="text-white font-semibold text-sm mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Supported Formats
                            </h2>
                            <ul class="text-gray-300 text-xs space-y-1">
                                <li><i class="fas fa-check text-green-500 mr-1"></i> GeoJSON (.geojson, .json)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> KML/KMZ (.kml, .kmz)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> GPX (.gpx)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> CSV with coordinates (.csv)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> WMS Services (Philippine Geoportal)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> ArcGIS REST Services</li>
                            </ul>
                            <div class="mt-2 text-xs text-gray-400">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
                                Maximum file size: 50MB
                            </div>
                        </div>
                    </div>
                </div>

            <!-- Filter Panel -->
            <div class="toolbar-panel" id="filter-panel" data-tool="filter">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-filter text-neon-teal mr-2"></i>Filter
                        </h1>
                    </div>
                    <div class="p-4 space-y-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <div class="glass-section p-4">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Feature Filter
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Filter features from visible layers based on attribute values.
                                </p>
                            </div>
                            
                            <!-- Step 1: Layer Selection -->
                            <div class="mb-4">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-layer-group mr-2"></i>Select Layer
                                </label>
                                <select id="filterLayerSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Choose a layer to filter</option>
                                </select>
                            </div>
                            
                            <!-- Step 2: Field Selection -->
                            <div id="filterFieldSection" class="mb-4" style="display: none;">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-table mr-2"></i>Select Field
                                </label>
                                <select id="filterFieldSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Choose a field to filter by</option>
                                </select>
                            </div>
                            
                            <!-- Step 3: Operator Selection -->
                            <div id="filterOperatorSection" class="mb-4" style="display: none;">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-filter mr-2"></i>Filter Operator
                                </label>
                                <select id="filterOperatorSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Choose how to filter</option>
                                    <option value="equal">Equal to</option>
                                    <option value="not_equal">Not equal to</option>
                                    <option value="include">Include (any of)</option>
                                    <option value="does_not_include">Does not include (any of)</option>
                                    <option value="contains">Contains text</option>
                                    <option value="does_not_contain">Does not contain text</option>
                                    <option value="starts_with">Starts with</option>
                                    <option value="does_not_start_with">Does not start with</option>
                                    <option value="is_empty">Is empty</option>
                                    <option value="is_not_empty">Is not empty</option>
                                    <option value="is_null">Is null</option>
                                    <option value="is_not_null">Is not null</option>
                                </select>
                            </div>
                            
                            <!-- Step 4: Value Input (Dynamic) -->
                            <div id="filterValueSection" style="display: none;">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-edit mr-2"></i>Filter Value
                                </label>
                                
                                <!-- Single Value Dropdown -->
                                <select id="filterSingleValueSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal" style="display: none;">
                                    <option value="">Loading values...</option>
                                </select>
                                
                                <!-- Multi-Value Selection -->
                                <div id="filterMultiValueContainer" style="display: none;">
                                    <div class="bg-pure-black border border-neon-teal/30 rounded p-2 max-h-32 overflow-y-auto">
                                        <div id="filterMultiValueList">
                                            <!-- Checkboxes will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Text Input -->
                                <input type="text" id="filterTextInput" placeholder="Enter text to filter by" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal placeholder:text-gray-500" style="display: none;">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div id="filterActionsSection" class="mt-6 space-y-2" style="display: none;">
                                <button id="applyFilterBtn" class="w-full px-4 py-2 bg-neon-teal/20 hover:bg-neon-teal/30 border border-neon-teal/40 hover:border-neon-teal text-white rounded transition-all text-sm font-medium flex items-center justify-center hover:shadow-neon-glow-sm">
                                    <i class="fas fa-check mr-2"></i>Apply Filter
                                </button>
                                <button id="clearFilterBtn" class="w-full px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-600/40 hover:border-red-600 text-white rounded transition-all text-sm font-medium flex items-center justify-center">
                                    <i class="fas fa-times mr-2"></i>Clear Filter
                                </button>
                            </div>
                            
                            <!-- Filter Selected Button (Always Visible) -->
                            <div class="mt-6">
                                <button id="filterSelectedBtn" class="w-full px-4 py-2 bg-green-600/20 hover:bg-green-600/30 border border-green-600/40 hover:border-green-600 disabled:bg-gray-600/20 disabled:border-gray-600/20 disabled:cursor-not-allowed text-white rounded transition-all text-sm font-medium flex items-center justify-center" disabled>
                                    <i class="fas fa-layer-group mr-2"></i>Filter Selected Features
                                </button>
                                <div class="text-xs text-gray-400 mt-2 text-center">
                                    <span id="selectedFeaturesCount">No features selected</span>
                                </div>
                            </div>
                            
                            <!-- Filter Status -->
                            <div id="filterStatusSection" style="display: none;">
                                <div class="mt-4 p-3 bg-neon-teal/10 border border-neon-teal/30 rounded">
                                    <div class="flex items-center">
                                        <i class="fas fa-filter text-neon-teal mr-2"></i>
                                        <span class="text-neon-teal text-sm font-medium">Filter Active</span>
                                    </div>
                                    <div id="filterStatusText" class="text-light-gray text-xs mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- Layers Panel -->
            <div class="toolbar-panel" id="layers-panel" data-tool="layers">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-layer-group text-neon-teal mr-2"></i>Layers
                        </h1>
                    </div>
                    <div class="p-4 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <div id="layersList" class="space-y-3">
                            <!-- Layers will be dynamically added here -->
                        </div>
                        <div id="noLayersMessage" class="text-center py-8 px-4 rounded-lg bg-black bg-opacity-20 border border-gray-600 border-opacity-20">
                            <div class="text-gray-400 mb-3">
                                <i class="fas fa-layer-group text-3xl"></i>
                            </div>
                            <p class="text-white text-sm font-medium">No layers loaded</p>
                            <p class="text-gray-400 text-xs mt-2">Add data using the <span class="text-neon-teal">Add Data</span> panel</p>
                        </div>
                    </div>
                </div>
                
            <!-- Legend Panel -->
            <div class="toolbar-panel" id="legend-panel" data-tool="legend">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-list text-neon-teal mr-2"></i>Legend
                        </h1>
                    </div>
                    <div class="p-4 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <div id="legendContent" class="space-y-3">
                            <!-- Legend items will be dynamically added here -->
                        </div>
                        <div id="noLegendMessage" class="text-center py-8 px-4 rounded-lg bg-black bg-opacity-20 border border-gray-600 border-opacity-20">
                            <div class="text-gray-400 mb-3">
                                <i class="fas fa-list text-3xl"></i>
                            </div>
                            <p class="text-white text-sm font-medium">No legend available</p>
                            <p class="text-gray-400 text-xs mt-2">Legend will appear when layers with <span class="text-neon-teal">symbology</span> are loaded</p>
                        </div>
                    </div>
                </div>
                
            <!-- Select Panel -->
            <div class="toolbar-panel" id="select-panel" data-tool="select">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-draw-polygon text-neon-teal mr-2"></i>Select Features
                        </h1>
                    </div>
                    <div class="p-4 space-y-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <!-- Selection Tools -->
                        <div class="border border-neon-teal/20 bg-pure-black p-4">
                            <div class="border-b border-neon-teal/10 pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Selection Tools
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Select features by drawing on the map to analyze data.
                                </p>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-layer-group mr-2"></i>Active Layer for Selection
                                </label>
                                <select id="activeLayerSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Select a layer first</option>
                                </select>
                            </div>
                            
                            <div class="space-y-2">
                                <button id="activateSelectTool" class="glass-button w-full px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded transition-all text-sm font-medium flex items-center justify-center" disabled>
                                    <i class="fas fa-draw-polygon mr-2"></i>Activate Selection Tool
                                </button>
                                <button id="clearSelection" class="glass-button w-full px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded transition-all text-sm font-medium flex items-center justify-center" disabled>
                                    <i class="fas fa-times mr-2"></i>Clear Selection
                                </button>
                                <button id="showStatistics" class="glass-button w-full px-4 py-2 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded transition-all text-sm font-medium flex items-center justify-center" disabled>
                                    <i class="fas fa-chart-bar mr-2"></i>Statistics
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection Counter -->
                        <div id="selectionInfo" class="selection-counter-card">
                            <div id="selectedCountNumber" class="selection-counter-number">0</div>
                            <div class="selection-counter-label">Features Selected</div>
                            <div id="selectedFeaturesList" class="mt-4 space-y-2 max-h-40 overflow-y-auto" style="display: none;">
                                <!-- Selected features will be listed here when count > 0 -->
                            </div>
                        </div>

                        <!-- Statistics Panel -->
                        <div id="statisticsPanel" class="border border-neon-teal/20 bg-pure-black p-4" style="display: none;">
                            <div class="border-b border-neon-teal/10 pb-2 mb-4">
                                <h3 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    <i class="fas fa-chart-bar mr-2"></i>Statistics
                                </h3>
                                <p class="text-light-gray text-xs">
                                    Perform statistical analysis on selected features.
                                </p>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">Field</label>
                                    <select id="statisticsFieldSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                        <option value="">Select a field</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">Operations</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                            <input type="checkbox" value="sum" class="statistics-operation-checkbox rounded border-neon-teal/30 bg-pure-black text-neon-teal focus:ring-neon-teal">
                                            <span>Sum</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                            <input type="checkbox" value="average" class="statistics-operation-checkbox rounded border-neon-teal/30 bg-pure-black text-neon-teal focus:ring-neon-teal">
                                            <span>Average</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                            <input type="checkbox" value="mode" class="statistics-operation-checkbox rounded border-neon-teal/30 bg-pure-black text-neon-teal focus:ring-neon-teal">
                                            <span>Mode</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                            <input type="checkbox" value="min" class="statistics-operation-checkbox rounded border-neon-teal/30 bg-pure-black text-neon-teal focus:ring-neon-teal">
                                            <span>Minimum</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                            <input type="checkbox" value="max" class="statistics-operation-checkbox rounded border-neon-teal/30 bg-pure-black text-neon-teal focus:ring-neon-teal">
                                            <span>Maximum</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="statisticsResults" class="mt-4" style="display: none;">
                                <!-- Statistical results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
            <!-- Labels Panel -->
            <div class="toolbar-panel" id="labels-panel" data-tool="labels">
                    <button class="panel-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="panel-header">
                        <h1 class="section-header text-white font-bold uppercase tracking-wide">
                            <i class="fas fa-tag text-neon-teal mr-2"></i>Labels
                        </h1>
                    </div>
                    <div class="p-4 space-y-6 max-h-[calc(100vh-8rem)] overflow-y-auto">
                        <!-- Layer Selection -->
                        <div class="glass-section p-4">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Layer Selection
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Choose a layer to display labels for its features.
                                </p>
                            </div>
                            
                            <!-- Layer Dropdown -->
                            <div class="mb-4">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-layer-group mr-2"></i>Select Layer
                                </label>
                                <select id="labelLayerSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Choose a layer to label</option>
                                </select>
                            </div>
                            
                            <!-- Field Selection -->
                            <div id="labelFieldSection" class="mb-4" style="display: none;">
                                <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                    <i class="fas fa-table mr-2"></i>Label Field
                                </label>
                                <select id="labelFieldSelect" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    <option value="">Choose field for labels</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Label Styling -->
                        <div id="labelStylingSection" class="glass-section p-4" style="display: none;">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Label Styling
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Customize the appearance of your labels.
                                </p>
                            </div>
                            
                            <!-- Font Settings -->
                            <div class="space-y-4">
                                <!-- Font Family -->
                                <div>
                                    <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                        <i class="fas fa-font mr-2"></i>Font Family
                                    </label>
                                    <select id="labelFontFamily" class="w-full px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                        <option value="Inter">Inter (Default)</option>
                                        <option value="Arial">Arial</option>
                                        <option value="Times New Roman">Times New Roman</option>
                                        <option value="Courier New">Courier New</option>
                                        <option value="Helvetica">Helvetica</option>
                                    </select>
                                </div>
                                
                                <!-- Font Size -->
                                <div>
                                    <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                        <i class="fas fa-text-height mr-2"></i>Font Size (px)
                                    </label>
                                    <input type="range" id="labelFontSize" min="8" max="24" value="12" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                                        <span>8px</span>
                                        <span id="labelFontSizeValue">12px</span>
                                        <span>24px</span>
                                    </div>
                                </div>
                                
                                <!-- Font Color -->
                                <div>
                                    <label class="block text-xs font-medium text-neon-teal mb-2 uppercase tracking-wider">
                                        <i class="fas fa-palette mr-2"></i>Font Color
                                    </label>
                                    <div class="flex items-center space-x-2">
                                        <input type="color" id="labelFontColor" value="#ffffff" class="w-8 h-8 rounded border border-neon-teal/30 bg-pure-black cursor-pointer">
                                        <input type="text" id="labelFontColorText" value="#ffffff" class="flex-1 px-3 py-2 bg-pure-black border border-neon-teal/30 rounded text-light-gray text-sm focus:outline-none focus:ring-1 focus:ring-neon-teal focus:border-neon-teal">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Label Placement (for points and lines) -->
                        <div id="labelPlacementSection" class="glass-section p-4" style="display: none;">
                            <div class="section-divider pb-2 mb-4">
                                <h2 class="text-neon-teal font-semibold text-xs uppercase tracking-wider mb-1">
                                    Label Placement
                                </h2>
                                <p class="text-light-gray text-xs">
                                    Choose how labels are positioned relative to features.
                                </p>
                            </div>
                            
                            <div class="space-y-3">
                                <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                    <input type="radio" name="labelPlacement" value="straight" class="text-neon-teal focus:ring-neon-teal" checked>
                                    <span>Straight (Horizontal)</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                    <input type="radio" name="labelPlacement" value="parallel" class="text-neon-teal focus:ring-neon-teal">
                                    <span>Parallel to Feature</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                    <input type="radio" name="labelPlacement" value="curved" class="text-neon-teal focus:ring-neon-teal">
                                    <span>Curved Along Path</span>
                                </label>
                                <label class="flex items-center space-x-2 text-sm text-light-gray cursor-pointer">
                                    <input type="radio" name="labelPlacement" value="free" class="text-neon-teal focus:ring-neon-teal">
                                    <span>Free (Angled) - QGIS Style</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div id="labelActionsSection" class="space-y-2" style="display: none;">
                            <button id="applyLabelsBtn" class="w-full px-4 py-2 bg-neon-teal/20 hover:bg-neon-teal/30 border border-neon-teal/40 hover:border-neon-teal text-white rounded transition-all text-sm font-medium flex items-center justify-center hover:shadow-neon-glow-sm">
                                <i class="fas fa-check mr-2"></i>Apply Labels
                            </button>
                            <button id="clearLabelsBtn" class="w-full px-4 py-2 bg-red-600/20 hover:bg-red-600/30 border border-red-600/40 hover:border-red-600 text-white rounded transition-all text-sm font-medium flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>Clear Labels
                            </button>
                        </div>
                    </div>
                </div>

        </div>
    </div>
    </div>



    <!-- Layer Context Menu removed - duplicate, using the one at bottom of page -->

    <!-- Map Context Menu for Basemap Selection -->
    <div id="mapContextMenu" class="custom-context-menu">
        <div class="context-menu-item context-menu-parent" id="changeBasemapOption">
            <i class="fas fa-map"></i>
            Change Basemap
            <i class="fas fa-chevron-right context-menu-arrow"></i>
            <div class="context-submenu" id="basemapSubmenu">
                <!-- OSM Group -->
                <div class="context-menu-group-header">OSM</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="osm-no-labels">
                    <span>
                        <i class="fas fa-map"></i>
                        OSM (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="osm-standard">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-hot">
                    <i class="fas fa-hand-holding-heart"></i>
                    OSM Humanitarian
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-opnv">
                    <i class="fas fa-subway"></i>
                    OSM ÃPNV (Public Transport)
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-dark">
                    <i class="fas fa-moon"></i>
                    OSM Dark
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-satellite">
                    <i class="fas fa-satellite"></i>
                    OSM Satellite
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- ESRI Group -->
                <div class="context-menu-group-header">ESRI</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="esri-world-imagery">
                    <span>
                        <i class="fas fa-satellite-dish"></i>
                        World Imagery (Satellite)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="esri-imagery-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="esri-streets">
                    <i class="fas fa-road"></i>
                    Street
                </div>
                <div class="context-menu-item basemap-option" data-basemap="esri-topo">
                    <i class="fas fa-mountain"></i>
                    Topo
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Google Group -->
                <div class="context-menu-group-header">Google</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="google-satellite">
                    <span>
                        <i class="fab fa-google"></i>
                        Satellite (no labels) [default]
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="google-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="google-hybrid">
                    <i class="fab fa-google"></i>
                    Hybrid
                </div>
                <div class="context-menu-item basemap-option" data-basemap="google-terrain">
                    <i class="fab fa-google"></i>
                    Terrain
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Bing Group -->
                <div class="context-menu-group-header">Bing</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="bing-aerial">
                    <span>
                        <i class="fas fa-plane"></i>
                        Bing Aerial (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="bing-aerial-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="bing-road">
                    <i class="fas fa-road"></i>
                    Road
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- CARTO Group -->
                <div class="context-menu-group-header">CARTO</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-positron">
                    <span>
                        <i class="fas fa-sun"></i>
                        Positron (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-positron-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-dark-matter">
                    <span>
                        <i class="fas fa-moon"></i>
                        Dark Matter (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-dark-matter-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-voyager">
                    <span>
                        <i class="fas fa-compass"></i>
                        Voyager (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-voyager-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Thunderforest Group -->
                <div class="context-menu-group-header">Thunderforest</div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-cycle">
                    <i class="fas fa-bicycle"></i>
                    Open Cycle
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-dark">
                    <i class="fas fa-moon"></i>
                    Thunderforest Dark
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-diablo">
                    <i class="fas fa-fire"></i>
                    Thunderforest Diablo
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-outdoor">
                    <i class="fas fa-mountain"></i>
                    Thunderforest Outdoor
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-old">
                    <i class="fas fa-history"></i>
                    Thunderforest Old
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-neighborhood">
                    <i class="fas fa-home"></i>
                    Thunderforest Neighborhood
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Maptiler Group -->
                <div class="context-menu-group-header">Maptiler</div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-aquarelle">
                    <i class="fas fa-paint-brush"></i>
                    Aquarelle
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-backdrop">
                    <i class="fas fa-image"></i>
                    Backdrop
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-topography">
                    <i class="fas fa-mountain"></i>
                    Topography
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-winter">
                    <i class="fas fa-snowflake"></i>
                    Winter
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="maptiler-openstreet-no-labels">
                    <span>
                        <i class="fas fa-map-marked"></i>
                        OpenStreet (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="maptiler-openstreet-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Waze Group -->
                <div class="context-menu-group-header">Other</div>
                <div class="context-menu-item basemap-option" data-basemap="waze">
                    <i class="fas fa-route"></i>
                    Waze
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End of webgisContainer -->

    
    
    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Legacy sidebar JS removed - now using custom toolbox system -->
    
    <!-- Native screenshot export now handled by Rust/Tauri -->
    
    <!-- FileSaver.js for Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    
    <!-- ESRI Leaflet for Basemaps -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    
    <!-- toGeoJSON for KML support -->
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    
    <!-- Turf.js for precise spatial analysis -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- PapaParse for CSV support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Global State Module -->
    <script src="js/global.js"></script>
    
    <!-- Renderer Configuration -->
    <script src="js/renderer-config.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global variables
        let map;
        let activeFilters = new Map();
        
        // Initialize global layer variables directly on window
        window.layers = new Map();
        window.layerOrder = []; // Array to track layer display order
        window.layerCounter = 0;
        window.contextMenuActivatedAt = null; // Timestamp for race condition prevention
        
        // **CUSTOM MODAL SYSTEM - ALERT, CONFIRM, AND PROMPT**
        
        // Generic modal function
        function showCustomModal(type, message, title, defaultValue = '', okText = 'OK', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const messageEl = document.getElementById('customModalMessage');
                const titleEl = document.getElementById('customModalTitle');
                const iconEl = document.getElementById('customModalIcon');
                const inputContainer = document.getElementById('customModalInput');
                const inputField = document.getElementById('customModalInputField');
                const buttonsContainer = document.getElementById('customModalButtons');
                const okBtn = document.getElementById('customModalOkBtn');
                const cancelBtn = document.getElementById('customModalCancelBtn');
                
                // Set the message and title
                messageEl.textContent = message;
                titleEl.textContent = title;
                
                // Configure modal based on type
                iconEl.className = 'confirm-modal-icon';
                inputContainer.style.display = 'none';
                cancelBtn.style.display = 'none';
                
                switch (type) {
                    case 'alert':
                        iconEl.classList.add('info');
                        iconEl.innerHTML = '<i class="fas fa-info-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'confirm':
                        iconEl.classList.add('question');
                        iconEl.innerHTML = '<i class="fas fa-question-circle"></i>';
                        okBtn.textContent = okText;
                        cancelBtn.textContent = cancelText;
                        cancelBtn.style.display = 'inline-block';
                        break;
                        
                    case 'prompt':
                        iconEl.classList.add('question');
                        iconEl.innerHTML = '<i class="fas fa-edit"></i>';
                        okBtn.textContent = okText;
                        cancelBtn.textContent = cancelText;
                        cancelBtn.style.display = 'inline-block';
                        inputContainer.style.display = 'block';
                        inputField.value = defaultValue || '';
                        inputField.placeholder = 'Enter value...';
                        break;
                        
                    case 'success':
                        iconEl.classList.add('success');
                        iconEl.innerHTML = '<i class="fas fa-check-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'warning':
                        iconEl.classList.add('warning');
                        iconEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'error':
                        iconEl.classList.add('error');
                        iconEl.innerHTML = '<i class="fas fa-times-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                }
                
                // Show the modal
                modal.classList.add('show');
                
                // Focus appropriate element
                setTimeout(() => {
                    if (type === 'prompt') {
                        inputField.focus();
                        inputField.select();
                    } else {
                        okBtn.focus();
                    }
                }, 100);
                
                // Handle button clicks and responses
                const handleOk = () => {
                    // Get the input value BEFORE cleanup
                    const inputValue = (type === 'prompt') ? inputField.value : null;
                    
                    cleanup();
                    
                    switch (type) {
                        case 'alert':
                        case 'success':
                        case 'warning':
                        case 'error':
                            resolve(true);
                            break;
                        case 'confirm':
                            resolve(true);
                            break;
                        case 'prompt':
                            resolve(inputValue);
                            break;
                    }
                };
                
                const handleCancel = () => {
                    cleanup();
                    
                    switch (type) {
                        case 'confirm':
                            resolve(false);
                            break;
                        case 'prompt':
                            resolve(null);
                            break;
                        default:
                            resolve(false);
                            break;
                    }
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleOk();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        if (type === 'alert' || type === 'success' || type === 'warning' || type === 'error') {
                            handleOk();
                        } else {
                            handleCancel();
                        }
                    }
                };
                
                const handleOverlayClick = (e) => {
                    if (e.target === modal) {
                        if (type === 'alert' || type === 'success' || type === 'warning' || type === 'error') {
                            handleOk();
                        } else {
                            handleCancel();
                        }
                    }
                };
                
                const cleanup = () => {
                    // Remove show class first
                    modal.classList.remove('show');
                    
                    // Remove event listeners
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKeydown);
                    modal.removeEventListener('click', handleOverlayClick);
                    
                    // Clear input field
                    inputField.value = '';
                    
                    // Force hide modal with timeout to ensure CSS transition completes
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.style.opacity = '0';
                        modal.style.visibility = 'hidden';
                        
                        // Reset styles after hiding
                        setTimeout(() => {
                            modal.style.display = '';
                            modal.style.opacity = '';
                            modal.style.visibility = '';
                        }, 100);
                    }, 300);
                };
                
                // Add event listeners
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleKeydown);
                modal.addEventListener('click', handleOverlayClick);
            });
        }
        
        // Public API functions
        function showAlert(message, title = 'Information') {
            return showCustomModal('alert', message, title);
        }
        
        function showConfirm(message, title = 'Confirm Action') {
            return showCustomModal('confirm', message, title);
        }
        
        function showPrompt(message, defaultValue = '', title = 'Input Required') {
            return showCustomModal('prompt', message, title, defaultValue);
        }
        
        function showSuccess(message, title = 'Success') {
            return showCustomModal('success', message, title);
        }
        
        function showWarning(message, title = 'Warning') {
            return showCustomModal('warning', message, title);
        }
        
        function showError(message, title = 'Error') {
            return showCustomModal('error', message, title);
        }
        
        // showNotification function - maps to existing modal system based on type
        function showNotification(message, type = 'info', duration = 3000) {
            switch (type) {
                case 'success':
                    return showSuccess(message);
                case 'error':
                    return showError(message);
                case 'warning':
                    return showWarning(message);
                case 'info':
                default:
                    return showAlert(message);
            }
        }

        // Make functions globally available
        window.showAlert = showAlert;
        window.showConfirm = showConfirm;
        window.showPrompt = showPrompt;
        window.showSuccess = showSuccess;
        window.showWarning = showWarning;
        window.showError = showError;
        window.showNotification = showNotification;
        
        // Selection tool variables - moved to selection-tools.js module

        // Middle mouse button panning variables
        let isMiddleMouseDown = false;

        // Modern Navigation functionality
        function initializeNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const appSections = document.querySelectorAll('.app-section');
            const navSidebar = document.getElementById('modernNavSidebar');
            const navSearchInput = document.getElementById('navSearchInput');
            
            // Navigation item click handlers
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetSection = item.getAttribute('data-section');
                    
                    // Update nav item states
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show/hide app sections
                    appSections.forEach(app => {
                        if (app.id === targetSection + 'Section') {
                            app.classList.add('active');
                            app.style.display = 'block';
                        } else {
                            app.classList.remove('active');
                            app.style.display = 'none';
                        }
                    });
                    
                    // Handle special cases
                    if (targetSection === 'map') {
                        // Ensure map is properly sized when shown
                        setTimeout(() => {
                            if (window.map) {
                                window.map.invalidateSize();
                            }
                        }, 100);
                    }
                });
            });
            
            
            
            // Search functionality
            if (navSearchInput) {
                navSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    navItems.forEach(item => {
                        const text = item.querySelector('.nav-item-text').textContent.toLowerCase();
                        const title = item.getAttribute('title').toLowerCase();
                        
                        if (text.includes(searchTerm) || title.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = searchTerm === '' ? 'block' : 'none';
                        }
                    });
                });
            }
        }
        
        
        // Floating toolbox functionality
        function initializeFloatingToolbox() {
            const toolButtons = document.querySelectorAll('.tool-btn');
            const toolbarPanels = document.querySelectorAll('.toolbar-panel');
            
            toolButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tool = btn.getAttribute('data-tool');
                    const targetPanel = document.getElementById(tool + '-panel');
                    
                    // Toggle button active state
                    const isActive = btn.classList.contains('active');
                    
                    if (isActive) {
                        // Deactivate current tool
                        btn.classList.remove('active');
                        if (targetPanel) {
                            targetPanel.classList.remove('active');
                        }
                    } else {
                        // Deactivate all other tools
                        toolButtons.forEach(otherBtn => otherBtn.classList.remove('active'));
                        toolbarPanels.forEach(panel => panel.classList.remove('active'));
                        
                        // Activate clicked tool
                        btn.classList.add('active');
                        if (targetPanel) {
                            targetPanel.classList.add('active');
                        }
                        
                    }
                });
            });
            
            // Close panel functionality
            const closeButtons = document.querySelectorAll('.toolbar-panel .panel-close-btn');
            closeButtons.forEach(closeBtn => {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const panel = closeBtn.closest('.toolbar-panel');
                    const tool = panel.getAttribute('data-tool');
                    const toolBtn = document.querySelector(`.tool-btn[data-tool="${tool}"]`);
                    
                    panel.classList.remove('active');
                    if (toolBtn) {
                        toolBtn.classList.remove('active');
                    }
                });
            });
        }
        

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Supabase first
            if (!initializeSupabase()) {
                await showError('Failed to connect to Supabase. Some features may not work properly.', 'Connection Error');
                return;
            }
            
            // Check if user is already logged in
            const user = await checkAuthState();
            
            if (user) {
                // User is logged in, show WebGIS interface
                initializeUserInterface(user);
                hideLoginPage();
                initializeWebGIS();
            } else {
                // User not logged in, show login page
                showLoginPage();
                setupLoginListeners();
            }
        });

        // Initialize user interface with avatar
        function initializeUserInterface(user) {
            // Set user avatar with initial (header)
            const userInitial = user.email.charAt(0).toUpperCase();
            document.getElementById('userInitial').textContent = userInitial;
            
            // Set navigation sidebar user info
            document.getElementById('navUserInitial').textContent = userInitial;
            document.getElementById('navUserName').textContent = user.email.split('@')[0]; // Use email username
            document.getElementById('navUserEmail').textContent = user.email;
            
            // Keep email for backward compatibility (but hidden)
            const userEmailElement = document.getElementById('userEmail');
            if (userEmailElement) {
                userEmailElement.textContent = user.email;
                userEmailElement.style.display = 'none'; // Hide the full email
            }
        }

        // Initialize WebGIS components
        function initializeWebGIS() {
            initializeMap();
            initializeNavigation();
            initializeFloatingToolbox();
            initializeEventListeners();
            loadInitialData();
            
            // Initialize print system
            if (typeof initializePrintSystem === 'function') {
                initializePrintSystem();
            }
        }

        // Initialize the Leaflet map
        function initializeMap() {
            map = L.map('map', {
                center: [14.5995, 120.9842], // Philippines center
                zoom: 6,
                zoomControl: true,
                dragging: true, // Enable normal left-click dragging
                doubleClickZoom: false, // Disable double-click zoom
                boxZoom: false, // Disable Shift+drag zoom box
                scrollWheelZoom: true // Default scroll wheel zoom behavior
            });

            // Initialize basemap system
            initBasemaps(map);

            // Move zoom control to bottom
            map.zoomControl.setPosition('bottomright');
            
            // Initialize selection tools
            initializeSelectionTools(map);
            
            // Add middle mouse button panning functionality
            initializeMiddleMousePanning();
            
            // Add Ctrl+right-click zoom box functionality
            initializeZoomBox(map);
        }



        // Initialize event listeners
        function initializeEventListeners() {
            // Disable default browser context menu for the entire WebGIS interface
            document.addEventListener('contextmenu', function(e) {
                // Prevent default browser context menu everywhere in the WebGIS interface
                e.preventDefault();
                e.stopPropagation();
                return false;
            });


            // Modal close listeners (but modals won't be opened from header buttons)
            setupModalListeners();
            
            // File upload listeners for modal (if needed)
            setupFileUploadListeners();
            
            // Symbology listeners
            setupSymbologyListeners();
            
            // Selection tool listeners
            setupSelectionListeners();

            // New comprehensive filter system
            setupNewFilterListeners();

            // Logout button listener
            setupLogoutListener();
        }
            

        // Setup file upload listeners
        function setupFileUploadListeners() {
            // Logic moved to add-data.js
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                await showWarning('Please select a file to upload.', 'No File Selected');
                return;
            }

            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                await showError('File size exceeds 50MB limit.', 'File Too Large');
                return;
            }

            // Check file type
            const validTypes = ['application/json', 'application/geo+json', 'application/vnd.google-earth.kml+xml'];
            const isValidType = validTypes.includes(file.type) || 
                               file.name.toLowerCase().endsWith('.geojson') || 
                               file.name.toLowerCase().endsWith('.json') || 
                               file.name.toLowerCase().endsWith('.kml') ||
                               file.name.toLowerCase().endsWith('.kmz');

            if (!isValidType) {
                await showError('Please upload a valid GeoJSON, KML, or KMZ file.', 'Invalid File Type');
                return;
            }

            showUploadProgress();

        // Logic moved to add-data.js

            // Handle middle mouse button down - start custom panning
            mapContainer.addEventListener('mousedown', function(e) {
                if (e.button === 1) { // Middle mouse button
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isMiddleMouseDown = true;
                    isDraggingWithMiddle = false;
                    startPoint = { x: e.clientX, y: e.clientY };
                    
                    // Change cursor to indicate panning mode
                    mapContainer.style.cursor = 'grab';
                }
            });

            // Handle mouse move for middle button panning
            mapContainer.addEventListener('mousemove', function(e) {
                if (isMiddleMouseDown && startPoint) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!isDraggingWithMiddle) {
                        // Start dragging - change cursor to grabbing
                        mapContainer.style.cursor = 'grabbing';
                        isDraggingWithMiddle = true;
                    }
                    
                    // Calculate movement delta
                    const deltaX = e.clientX - startPoint.x;
                    const deltaY = e.clientY - startPoint.y;
                    
                    // Only pan if there's significant movement to avoid jitter
                    if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
                        // Get current map center
                        const currentCenter = map.getCenter();
                        
                        // Convert pixel movement to lat/lng movement
                        const pixelBounds = map.getPixelBounds();
                        const pixelOrigin = map.getPixelOrigin();
                        
                        // Calculate new center based on pixel movement
                        const currentPixel = map.latLngToContainerPoint(currentCenter);
                        const newPixel = L.point(currentPixel.x - deltaX, currentPixel.y - deltaY);
                        const newCenter = map.containerPointToLatLng(newPixel);
                        
                        // Pan to new center
                        map.panTo(newCenter, { animate: false });
                        
                        // Update start point for next movement
                        startPoint = { x: e.clientX, y: e.clientY };
                    }
                }
            });

            // Handle middle mouse button up - stop custom panning
            mapContainer.addEventListener('mouseup', function(e) {
                if (e.button === 1 && isMiddleMouseDown) { // Middle mouse button
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isMiddleMouseDown = false;
                    isDraggingWithMiddle = false;
                    startPoint = null;
                    
                    // Restore appropriate cursor based on current tool
                    if (isSelectionActive) {
                        mapContainer.style.cursor = 'crosshair';
                    } else {
                        mapContainer.style.cursor = '';
                    }
                }
            });

            // Handle mouse leave - stop panning if middle button was held
            mapContainer.addEventListener('mouseleave', function(e) {
                if (isMiddleMouseDown) {
                    isMiddleMouseDown = false;
                    isDraggingWithMiddle = false;
                    startPoint = null;
                    
                    // Restore appropriate cursor
                    if (isSelectionActive) {
                        mapContainer.style.cursor = 'crosshair';
                    } else {
                        mapContainer.style.cursor = '';
                    }
                }
            });

            // Prevent middle button from interfering with other mouse events
            mapContainer.addEventListener('click', function(e) {
                if (e.button === 1) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        // Initialize Ctrl+Right-Click Zoom Box functionality
        function initializeZoomBox(mapInstance) {
            const mapContainer = mapInstance.getContainer();
            let isZoomBoxActive = false;
            let startPoint = null;
            let zoomBox = null;
            
            // Create zoom box element
            function createZoomBox() {
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.border = '2px dashed #0078d4';
                box.style.backgroundColor = 'rgba(0, 120, 212, 0.1)';
                box.style.pointerEvents = 'none';
                box.style.zIndex = '1000';
                box.style.display = 'none';
                mapContainer.appendChild(box);
                return box;
            }
            
            // Initialize zoom box element
            zoomBox = createZoomBox();
            
            // Handle right mouse button down with Ctrl
            mapContainer.addEventListener('mousedown', function(e) {
                // Only activate on right mouse button (2) with Ctrl key
                if (e.button === 2 && e.ctrlKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isZoomBoxActive = true;
                    startPoint = { x: e.clientX, y: e.clientY };
                    
                    // Get container offset for positioning
                    const rect = mapContainer.getBoundingClientRect();
                    const containerX = e.clientX - rect.left;
                    const containerY = e.clientY - rect.top;
                    
                    // Position zoom box at mouse location
                    zoomBox.style.left = containerX + 'px';
                    zoomBox.style.top = containerY + 'px';
                    zoomBox.style.width = '0px';
                    zoomBox.style.height = '0px';
                    zoomBox.style.display = 'block';
                    
                    // Disable map dragging during zoom box operation
                    mapInstance.dragging.disable();
                    
                    // Change cursor to crosshair
                    mapContainer.style.cursor = 'crosshair';
                }
            });
            
            // Handle mouse move for zoom box drawing
            mapContainer.addEventListener('mousemove', function(e) {
                if (isZoomBoxActive && startPoint) {
                    e.preventDefault();
                    
                    const rect = mapContainer.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    const startX = startPoint.x - rect.left;
                    const startY = startPoint.y - rect.top;
                    
                    // Calculate box dimensions
                    const left = Math.min(startX, currentX);
                    const top = Math.min(startY, currentY);
                    const width = Math.abs(currentX - startX);
                    const height = Math.abs(currentY - startY);
                    
                    // Update zoom box position and size
                    zoomBox.style.left = left + 'px';
                    zoomBox.style.top = top + 'px';
                    zoomBox.style.width = width + 'px';
                    zoomBox.style.height = height + 'px';
                }
            });
            
            // Handle right mouse button up - complete zoom box
            mapContainer.addEventListener('mouseup', function(e) {
                if (e.button === 2 && isZoomBoxActive) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const rect = mapContainer.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    const startX = startPoint.x - rect.left;
                    const startY = startPoint.y - rect.top;
                    
                    // Calculate minimum box size (prevent accidental tiny zooms)
                    const minBoxSize = 10;
                    const width = Math.abs(endX - startX);
                    const height = Math.abs(endY - startY);
                    
                    if (width > minBoxSize && height > minBoxSize) {
                        // Convert screen coordinates to map coordinates
                        const corner1 = mapInstance.containerPointToLatLng([startX, startY]);
                        const corner2 = mapInstance.containerPointToLatLng([endX, endY]);
                        
                        // Create bounds from the two corners
                        const bounds = L.latLngBounds([corner1, corner2]);
                        
                        // Zoom to the drawn rectangle with smooth animation
                        mapInstance.fitBounds(bounds, {
                            animate: true,
                            duration: 0.5,
                            padding: [5, 5] // Small padding for better visual appearance
                        });
                    }
                    
                    // Clean up
                    isZoomBoxActive = false;
                    startPoint = null;
                    zoomBox.style.display = 'none';
                    
                    // Re-enable map dragging
                    mapInstance.dragging.enable();
                    
                    // Reset cursor
                    mapContainer.style.cursor = '';
                }
            });
            
            // Handle context menu prevention during zoom box operation
            mapContainer.addEventListener('contextmenu', function(e) {
                if (e.ctrlKey || isZoomBoxActive) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // Clean up on mouse leave
            mapContainer.addEventListener('mouseleave', function(e) {
                if (isZoomBoxActive) {
                    isZoomBoxActive = false;
                    startPoint = null;
                    zoomBox.style.display = 'none';
                    mapInstance.dragging.enable();
                    mapContainer.style.cursor = '';
                }
            });
        }

    </script>


    <script src="js/add-data.js"></script>
    
    <!-- Map Print Module -->
    <script src="js/map-print.js"></script>

</body>
</html>

