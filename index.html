<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aera Link</title>
    
    <!-- Tailwind CSS (Development version) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom colors for the app
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <!-- Leaflet Sidebar CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css" />
    
    <!-- Heroicons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Avenir Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-900 text-white overflow-hidden">
    <!-- Authentication Module -->
    <script src="js/authentication.js"></script>
    
    <!-- Basemap Manager Module -->
    <script src="js/basemap-manager.js"></script>
    
    <!-- Filter System Module -->
    <script src="js/filter-system.js"></script>
    
    <!-- Selection Tools Module -->
    <script src="js/selection-tools.js"></script>
    
    <!-- Layer Manager Module -->
    <script src="js/layer-manager.js"></script>
    
    <!-- Symbology Editor Module -->
    <script src="js/symbology-editor.js"></script>

    <!-- Interaction Handlers Module -->
    <script src="js/interaction-handlers.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        try {
          if (window.map && typeof bindPopupHandlers === 'function') {
            bindPopupHandlers(window.map);
          }
        } catch (error) {
          console.error("Error in popup logic:", error);
        }
      });
    </script>
    
    <!-- Custom Confirmation Modal -->
    <div id="customModal" class="confirm-modal-overlay">
        <div class="confirm-modal">
            <div id="customModalIcon" class="confirm-modal-icon"></div>
            <div id="customModalTitle" class="confirm-modal-title">Confirm Action</div>
            <div id="customModalMessage" class="confirm-modal-message">
                Are you sure you want to continue?
            </div>
            <div id="customModalInput" class="confirm-modal-input-container" style="display: none;">
                <input type="text" id="customModalInputField" class="confirm-modal-input" placeholder="Enter value...">
            </div>
            <div id="customModalButtons" class="confirm-modal-buttons">
                <button id="customModalOkBtn" class="confirm-modal-btn confirm-modal-btn-ok">OK</button>
                <button id="customModalCancelBtn" class="confirm-modal-btn confirm-modal-btn-cancel" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Login Container -->
    <div id="loginContainer">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">Aéra Link</h1>
                <p class="login-subtitle">AKL Online Portal</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="form-input" 
                        placeholder="Enter your email address"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <div class="password-input-container">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input has-toggle" 
                            placeholder="Enter your password"
                            required
                        >
                        <button type="button" class="password-toggle-btn" id="passwordToggle">
                            <i class="fas fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" id="loginButton" class="login-button">
                    Sign In to WebGIS
                </button>
                
                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Forgot your password?</a>
                </div>
            </form>
        </div>
    </div>

    <!-- WebGIS Container -->
    <div id="webgisContainer" style="display: none;">
        <!-- Header -->
        <div class="header-container">
            <header class="glass-effect fixed top-0 left-0 right-0 z-50 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <img src="assets/AERA LOGO.png" alt="Aera Logo" class="h-12 w-auto">
                    </div>
                    
                    <!-- User Info and Logout -->
                    <div class="user-info">
                        <span id="userEmail" class="user-email"></span>
                        <button id="logoutButton" class="logout-button">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </header>
        </div>

    <!-- Main Content -->
    <div class="main-content-container pt-20 h-screen">
        <!-- Map Container -->
        <div id="map"></div>
        
        <!-- Print Controls -->
        <div class="print-controls" style="display: none;">
            <div class="flex items-center gap-2">
                <select id="exportQuality" class="bg-gray-700 border border-gray-600 text-white rounded-md px-3 py-2 text-sm">
                    <option value="1">Low Quality (1x)</option>
                    <option value="2" selected>Medium Quality (2x)</option>
                    <option value="3">High Quality (3x)</option>
                    <option value="4">Ultra Quality (4x)</option>
                </select>
                <button class="print-now bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2" onclick="triggerExport()">
                    <i class="fas fa-file-export"></i>
                    <span class="button-text">Export as PNG</span>
                </button>
                <button class="exit-print bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2" onclick="exitPrintMode()">
                    <i class="fas fa-times"></i>
                    <span>Exit Print View</span>
                </button>
            </div>
        </div>
        
        <!-- Print Tip -->
        <div class="print-tip">
            <i class="fas fa-info-circle"></i>
            Click "Export as PNG" to save the current map view
        </div>
        
        <!-- Floating Statistics Cards Container -->
        <div id="floatingStatisticsContainer" class="fixed top-24 right-2 sm:right-6 z-[1150] space-y-3 w-64 sm:w-72 lg:w-80 max-w-[90vw] max-h-[calc(100vh-8rem)] overflow-y-auto pr-2 sm:pr-0" style="display: none;">
            <!-- Statistics cards will be dynamically added here -->
        </div>
        
        <!-- Sidebar -->
        <div id="sidebar" class="leaflet-sidebar collapsed">
            <!-- Layers Tab -->
            <div class="leaflet-sidebar-tabs">
                <ul role="tablist">
                    <li><a href="#add-data-panel" role="tab"><i class="fas fa-plus"></i></a></li>
                    <li><a href="#filter-panel" role="tab"><i class="fas fa-filter"></i></a></li>
                    <li><a href="#layers-panel" role="tab"><i class="fas fa-layer-group"></i></a></li>
                    <li><a href="#legend-panel" role="tab"><i class="fas fa-list"></i></a></li>
                    <li><a href="#select-panel" role="tab"><i class="fas fa-draw-polygon"></i></a></li>
                    <li id="printLayoutBtn" class="cursor-pointer" title="Print Layout Editor">
                        <a role="button"><i class="fas fa-print"></i></a>
                    </li>
                </ul>
            </div>
            
            <div class="leaflet-sidebar-content">
                <!-- Add Data Panel -->
                <div class="leaflet-sidebar-pane" id="add-data-panel">
                    <h1 class="leaflet-sidebar-header text-white font-bold text-lg mb-4">
                        Add Data
                        <span class="leaflet-sidebar-close"><i class="fas fa-times"></i></span>
                    </h1>
                    <div class="space-y-4">
                        <!-- Local File Upload Section -->
                        <div class="glass-panel rounded-lg p-4">
                            <h2 class="text-white font-semibold text-sm mb-3">
                                <i class="fas fa-file-upload mr-2"></i>Add Data from File
                            </h2>
                            <p class="text-gray-300 text-xs mb-4">
                                Upload GeoJSON, KML, KMZ, GPX, or CSV files from your computer.
                            </p>
                            <div class="flex flex-col gap-2">
                                <input type="file" id="fileInput" class="hidden" accept=".geojson,.json,.kml,.kmz,.gpx,.csv" multiple />
                                <button id="uploadFileBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium flex items-center justify-center">
                                    <i class="fas fa-folder-open mr-2"></i>Choose Files
                                </button>
                                <div id="uploadFileList" class="text-sm text-gray-300 mt-2 hidden">
                                    <div class="text-xs font-medium mb-1">Selected files:</div>
                                    <ul class="list-disc list-inside"></ul>
                                </div>
                            </div>
                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="mt-4 hidden">
                                <div class="flex justify-between text-xs text-gray-300 mb-1">
                                    <span>Uploading...</span>
                                    <span id="uploadPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="uploadProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Web URL Section -->
                        <div class="glass-panel rounded-lg p-4">
                            <h2 class="text-white font-semibold text-sm mb-3">
                                <i class="fas fa-globe mr-2"></i>Add Data from Web
                            </h2>
                            <p class="text-gray-300 text-xs mb-4">
                                Enter a URL to load GeoJSON, KML, KMZ, GPX, or CSV data from the web.
                            </p>
                            <div class="flex flex-col gap-2">
                                <input type="url" id="webUrlInput" 
                                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="https://services.arcgis.com/.../FeatureServer/0" />
                                    <div class="text-xs text-gray-400 mt-1">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Supports direct file URLs (.geojson, .kml, etc.) and ArcGIS REST service URLs
                                    </div>
                                    <button id="loadUrlBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium flex items-center justify-center mt-2">
                                        <i class="fas fa-download mr-2"></i>Load from URL
                                    </button>
                            </div>
                            <!-- URL Load Progress -->
                            <div id="urlLoadProgress" class="mt-4 hidden">
                                <div class="flex justify-between text-xs text-gray-300 mb-1">
                                    <span>Loading...</span>
                                    <span id="urlLoadPercentage">0%</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="urlLoadProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Supported Formats Info -->
                        <div class="glass-panel rounded-lg p-4">
                            <h2 class="text-white font-semibold text-sm mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Supported Formats
                            </h2>
                            <ul class="text-gray-300 text-xs space-y-1">
                                <li><i class="fas fa-check text-green-500 mr-1"></i> GeoJSON (.geojson, .json)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> KML/KMZ (.kml, .kmz)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> GPX (.gpx)</li>
                                <li><i class="fas fa-check text-green-500 mr-1"></i> CSV with coordinates (.csv)</li>
                            </ul>
                            <div class="mt-2 text-xs text-gray-400">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-1"></i>
                                Maximum file size: 50MB
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div class="leaflet-sidebar-pane" id="filter-panel">
                    <h1 class="leaflet-sidebar-header text-white font-bold text-lg mb-4">
                        Filter
                        <span class="leaflet-sidebar-close"><i class="fas fa-times"></i></span>
                    </h1>
                    <div class="space-y-4">
                        <div class="glass-panel rounded-lg p-4">
                            <p class="text-gray-300 text-sm mb-4">Filter features from visible layers based on attribute values.</p>
                            
                            <!-- Step 1: Layer Selection -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-layer-group mr-2"></i>Select Layer
                                </label>
                                <select id="filterLayerSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Choose a layer to filter</option>
                                </select>
                            </div>
                            
                            <!-- Step 2: Field Selection -->
                            <div id="filterFieldSection" class="mb-4" style="display: none;">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-table mr-2"></i>Select Field
                                </label>
                                <select id="filterFieldSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Choose a field to filter by</option>
                                </select>
                            </div>
                            
                            <!-- Step 3: Operator Selection -->
                            <div id="filterOperatorSection" class="mb-4" style="display: none;">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-filter mr-2"></i>Filter Operator
                                </label>
                                <select id="filterOperatorSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Choose how to filter</option>
                                    <option value="equal">Equal to</option>
                                    <option value="not_equal">Not equal to</option>
                                    <option value="include">Include (any of)</option>
                                    <option value="does_not_include">Does not include (any of)</option>
                                    <option value="contains">Contains text</option>
                                    <option value="does_not_contain">Does not contain text</option>
                                    <option value="starts_with">Starts with</option>
                                    <option value="does_not_start_with">Does not start with</option>
                                    <option value="is_empty">Is empty</option>
                                    <option value="is_not_empty">Is not empty</option>
                                    <option value="is_null">Is null</option>
                                    <option value="is_not_null">Is not null</option>
                                </select>
                            </div>
                            
                            <!-- Step 4: Value Input (Dynamic) -->
                            <div id="filterValueSection" style="display: none;">
                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                    <i class="fas fa-edit mr-2"></i>Filter Value
                                </label>
                                
                                <!-- Single Value Dropdown -->
                                <select id="filterSingleValueSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="display: none;">
                                    <option value="">Loading values...</option>
                                </select>
                                
                                <!-- Multi-Value Selection -->
                                <div id="filterMultiValueContainer" style="display: none;">
                                    <div class="bg-gray-800 border border-gray-600 rounded-md p-2 max-h-32 overflow-y-auto">
                                        <div id="filterMultiValueList">
                                            <!-- Checkboxes will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Text Input -->
                                <input type="text" id="filterTextInput" placeholder="Enter text to filter by" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="display: none;">
                            </div>
                            
                            <!-- Action Buttons -->
                            <div id="filterActionsSection" class="mt-6 space-y-2" style="display: none;">
                                <button id="applyFilterBtn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium">
                                    <i class="fas fa-check mr-2"></i>Apply Filter
                                </button>
                                <button id="clearFilterBtn" class="w-full px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md transition-colors text-sm font-medium">
                                    <i class="fas fa-times mr-2"></i>Clear Filter
                                </button>
                            </div>
                            
                            <!-- Filter Selected Button (Always Visible) -->
                            <div class="mt-6">
                                <button id="filterSelectedBtn" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white rounded-md transition-colors text-sm font-medium" disabled>
                                    <i class="fas fa-layer-group mr-2"></i>Filter Selected Features
                                </button>
                                <div class="text-xs text-gray-400 mt-1 text-center">
                                    <span id="selectedFeaturesCount">No features selected</span>
                                </div>
                            </div>
                            
                            <!-- Filter Status -->
                            <div id="filterStatusSection" style="display: none;">
                                <div class="mt-4 p-3 bg-green-900/30 border border-green-600/50 rounded-md">
                                    <div class="flex items-center">
                                        <i class="fas fa-filter text-green-400 mr-2"></i>
                                        <span class="text-green-300 text-sm font-medium">Filter Active</span>
                                    </div>
                                    <div id="filterStatusText" class="text-gray-300 text-xs mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Layers Panel -->
                <div class="leaflet-sidebar-pane" id="layers-panel">
                    <h1 class="leaflet-sidebar-header text-white font-bold text-lg mb-4">
                        Layers
                        <span class="leaflet-sidebar-close"><i class="fas fa-times"></i></span>
                    </h1>
                    <div id="layersList" class="space-y-3">
                        <!-- Layers will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Legend Panel -->
                <div class="leaflet-sidebar-pane" id="legend-panel">
                    <h1 class="leaflet-sidebar-header text-white font-bold text-lg mb-4">
                        Legend
                        <span class="leaflet-sidebar-close"><i class="fas fa-times"></i></span>
                    </h1>
                    <div id="legendContent" class="space-y-2">
                        <!-- Legend items will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Select Panel -->
                <div class="leaflet-sidebar-pane" id="select-panel">
                    <h1 class="leaflet-sidebar-header text-white font-bold text-lg mb-4">
                        Select Features
                        <span class="leaflet-sidebar-close"><i class="fas fa-times"></i></span>
                    </h1>
                    <div class="space-y-4">
                        <div class="glass-panel rounded-lg p-4">
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Active Layer for Selection</label>
                                <select id="activeLayerSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                    <option value="">Select a layer first</option>
                                </select>
                            </div>
                            <button id="activateSelectTool" class="w-full px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md mb-3" disabled>
                                <i class="fas fa-draw-polygon mr-2"></i>Activate Selection Tool
                            </button>
                            <button id="clearSelection" class="w-full px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md" disabled>
                                <i class="fas fa-times mr-2"></i>Clear Selection
                            </button>
                            <button id="showStatistics" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md mt-3" disabled>
                                <i class="fas fa-chart-bar mr-2"></i>Statistics
                            </button>
                        </div>
                        <div id="selectionInfo" class="selection-counter-card">
                            <div id="selectedCountNumber" class="selection-counter-number">0</div>
                            <div class="selection-counter-label">Features Selected</div>
                            <div id="selectedFeaturesList" class="mt-4 space-y-2 max-h-40 overflow-y-auto" style="display: none;">
                                <!-- Selected features will be listed here when count > 0 -->
                            </div>
                        </div>

                        <!-- Statistics Panel -->
                        <div id="statisticsPanel" class="glass-panel rounded-lg p-4" style="display: none;">
                            <h3 class="text-white font-semibold mb-3">
                                <i class="fas fa-chart-bar mr-2"></i>Statistics
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Field</label>
                                    <select id="statisticsFieldSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                        <option value="">Select a field</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Operations</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" value="sum" class="statistics-operation-checkbox rounded border-gray-600 bg-gray-700 text-teal-500 focus:ring-teal-500">
                                            <span>Sum</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" value="average" class="statistics-operation-checkbox rounded border-gray-600 bg-gray-700 text-teal-500 focus:ring-teal-500">
                                            <span>Average</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" value="mode" class="statistics-operation-checkbox rounded border-gray-600 bg-gray-700 text-teal-500 focus:ring-teal-500">
                                            <span>Mode</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" value="min" class="statistics-operation-checkbox rounded border-gray-600 bg-gray-700 text-teal-500 focus:ring-teal-500">
                                            <span>Minimum</span>
                                        </label>
                                        <label class="flex items-center space-x-2 text-sm text-gray-300 cursor-pointer">
                                            <input type="checkbox" value="max" class="statistics-operation-checkbox rounded border-gray-600 bg-gray-700 text-teal-500 focus:ring-teal-500">
                                            <span>Maximum</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div id="statisticsResults" class="mt-4" style="display: none;">
                                <!-- Statistical results will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Data Button (place this in your main toolbar or sidebar as needed) -->
    <!-- Removed: No external Add Data button allowed. Only sidebar button remains. -->

    <!-- Add Data Modal (if not present, add this near the end of <body>) -->
    <!-- Add Data Modal logic moved to add-data.js -->

    <!-- Filter Modal -->
    <div id="filterModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center">
        <div class="glass-panel rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Filter Features</h2>
                <button id="closeFilterModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Layer</label>
                    <select id="filterLayer" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Field</label>
                    <select id="filterField" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Value</label>
                    <input type="text" id="filterValue" placeholder="Enter value to filter by"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="clearFilter" class="px-4 py-2 text-orange-400 hover:text-orange-300">Clear Filter</button>
                    <button id="applyFilter" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md">
                        Apply Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Symbology Modal -->
    <div id="symbologyModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center">
        <div class="glass-panel rounded-lg p-6 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Layer Symbology</h2>
                <button id="closeSymbologyModal" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Style Type</label>
                    <select id="styleType" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <option value="single">Single Symbol</option>
                        <option value="categorical">Categorical</option>
                    </select>
                </div>
                
                <div id="singleSymbolOptions">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Color</label>
                    <input type="color" id="singleColor" value="#14b8a6" class="w-16 h-10 bg-transparent border border-gray-600 rounded">
                </div>
                
                <div id="categoricalOptions" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Classify by Field</label>
                    <select id="classifyField" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <!-- Options populated dynamically -->
                    </select>
                    <div id="classificationRules" class="mt-4 space-y-2">
                        <!-- Classification rules will be added here -->
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancelSymbology" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button id="applySymbology" class="px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-md">
                        Apply
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Layer Context Menu -->
    <div id="layerContextMenu" class="custom-context-menu">
        <div class="context-menu-item" id="contextZoomToLayer">
            <i class="fas fa-search-plus"></i>
            Zoom to Layer
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="contextRename">
            <i class="fas fa-edit"></i>
            Rename
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="contextProperties">
            <i class="fas fa-palette"></i>
            Properties
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="contextDelete">
            <i class="fas fa-trash"></i>
            Delete
        </div>
    </div>

    <!-- Map Context Menu for Basemap Selection -->
    <div id="mapContextMenu" class="custom-context-menu">
        <div class="context-menu-item context-menu-parent" id="changeBasemapOption">
            <i class="fas fa-map"></i>
            Change Basemap
            <i class="fas fa-chevron-right context-menu-arrow"></i>
            <div class="context-submenu" id="basemapSubmenu">
                <!-- OSM Group -->
                <div class="context-menu-group-header">OSM</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="osm-no-labels">
                    <span>
                        <i class="fas fa-map"></i>
                        OSM (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="osm-standard">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-hot">
                    <i class="fas fa-hand-holding-heart"></i>
                    OSM Humanitarian
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-opnv">
                    <i class="fas fa-subway"></i>
                    OSM ÖPNV (Public Transport)
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-dark">
                    <i class="fas fa-moon"></i>
                    OSM Dark
                </div>
                <div class="context-menu-item basemap-option" data-basemap="osm-satellite">
                    <i class="fas fa-satellite"></i>
                    OSM Satellite
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- ESRI Group -->
                <div class="context-menu-group-header">ESRI</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="esri-world-imagery">
                    <span>
                        <i class="fas fa-satellite-dish"></i>
                        World Imagery (Satellite)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="esri-imagery-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="esri-streets">
                    <i class="fas fa-road"></i>
                    Street
                </div>
                <div class="context-menu-item basemap-option" data-basemap="esri-topo">
                    <i class="fas fa-mountain"></i>
                    Topo
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Google Group -->
                <div class="context-menu-group-header">Google</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="google-satellite">
                    <span>
                        <i class="fab fa-google"></i>
                        Satellite (no labels) [default]
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="google-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="google-hybrid">
                    <i class="fab fa-google"></i>
                    Hybrid
                </div>
                <div class="context-menu-item basemap-option" data-basemap="google-terrain">
                    <i class="fab fa-google"></i>
                    Terrain
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Bing Group -->
                <div class="context-menu-group-header">Bing</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="bing-aerial">
                    <span>
                        <i class="fas fa-plane"></i>
                        Bing Aerial (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="bing-aerial-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option" data-basemap="bing-road">
                    <i class="fas fa-road"></i>
                    Road
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- CARTO Group -->
                <div class="context-menu-group-header">CARTO</div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-positron">
                    <span>
                        <i class="fas fa-sun"></i>
                        Positron (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-positron-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-dark-matter">
                    <span>
                        <i class="fas fa-moon"></i>
                        Dark Matter (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-dark-matter-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="carto-voyager">
                    <span>
                        <i class="fas fa-compass"></i>
                        Voyager (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="carto-voyager-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Thunderforest Group -->
                <div class="context-menu-group-header">Thunderforest</div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-cycle">
                    <i class="fas fa-bicycle"></i>
                    Open Cycle
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-dark">
                    <i class="fas fa-moon"></i>
                    Thunderforest Dark
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-diablo">
                    <i class="fas fa-fire"></i>
                    Thunderforest Diablo
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-outdoor">
                    <i class="fas fa-mountain"></i>
                    Thunderforest Outdoor
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-old">
                    <i class="fas fa-history"></i>
                    Thunderforest Old
                </div>
                <div class="context-menu-item basemap-option" data-basemap="thunderforest-neighborhood">
                    <i class="fas fa-home"></i>
                    Thunderforest Neighborhood
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Maptiler Group -->
                <div class="context-menu-group-header">Maptiler</div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-aquarelle">
                    <i class="fas fa-paint-brush"></i>
                    Aquarelle
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-backdrop">
                    <i class="fas fa-image"></i>
                    Backdrop
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-topography">
                    <i class="fas fa-mountain"></i>
                    Topography
                </div>
                <div class="context-menu-item basemap-option" data-basemap="maptiler-winter">
                    <i class="fas fa-snowflake"></i>
                    Winter
                </div>
                <div class="context-menu-item basemap-option satellite-option" data-basemap="maptiler-openstreet-no-labels">
                    <span>
                        <i class="fas fa-map-marked"></i>
                        OpenStreet (no labels)
                    </span>
                    <label class="label-toggle">
                        <input type="checkbox" class="label-checkbox" data-labels="maptiler-openstreet-labels">
                        <span class="label-text">+ Show Labels</span>
                    </label>
                </div>
                
                <div class="context-menu-separator"></div>
                
                <!-- Waze Group -->
                <div class="context-menu-group-header">Other</div>
                <div class="context-menu-item basemap-option" data-basemap="waze">
                    <i class="fas fa-route"></i>
                    Waze
                </div>
            </div>
        </div>
    </div>
    </div> <!-- End of webgisContainer -->

    <!-- Print Layout Overlay -->
    <div id="printOverlay" class="fixed inset-0 z-[9999] bg-black/70 hidden">
        <div class="w-full h-full relative">
            <!-- Print Map Container -->
            <div id="printMapContainer" class="w-full h-full"></div>
            
            <!-- Print Controls (hidden during print) -->
            <div class="print-exclude fixed top-4 right-4 flex gap-2">
                <button id="printNowBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium flex items-center justify-center">
                    <i class="fas fa-print mr-2"></i>Print Now
                </button>
                <button id="exitPrintBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors text-sm font-medium flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i>Exit Print View
                </button>
            </div>
        </div>
    </div>
    
    <!-- Print Mode Styles -->
    <style>
        /* Print mode styles */
        body.print-mode {
            overflow: hidden !important;
        }
        
        body.print-mode .header-container,
        body.print-mode .leaflet-sidebar,
        body.print-mode .leaflet-control-container,
        body.print-mode #filterModal,
        body.print-mode #symbologyModal,
        body.print-mode #layerContextMenu,
        body.print-mode #mapContextMenu {
            display: none !important;
        }
        
        body.print-mode .main-content-container {
            padding: 0 !important;
        }
        
        body.print-mode #map {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Print controls */
        .print-controls {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 10000;
            display: flex;
            gap: 0.5rem;
            pointer-events: auto;
        }
        
        .print-controls button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .print-controls .print-now {
            background-color: #2563eb;
            color: white;
        }
        
        .print-controls .print-now:hover {
            background-color: #1d4ed8;
        }
        
        .print-controls .exit-print {
            background-color: #4b5563;
            color: white;
        }
        
        .print-controls .exit-print:hover {
            background-color: #374151;
        }
        
        .print-tip {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            z-index: 10000;
            pointer-events: none;
            display: none;
        }
        
        body.print-mode .print-tip {
            display: block;
        }
        
        /* Hide print controls during actual print */
        @media print {
            .print-controls,
            .print-tip {
                display: none !important;
            }
            
            #map {
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            @page {
                margin: 0;
                padding: 0;
                size: auto;
            }
        }
    </style>
    
    <!-- Scripts -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Leaflet Sidebar JS -->
    <script src="https://unpkg.com/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script>
    
    <!-- html2canvas for Map Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- FileSaver.js for Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Leaflet EasyPrint -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>
    
    <!-- ESRI Leaflet for Basemaps -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    
    <!-- toGeoJSON for KML support -->
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    
    <!-- Turf.js for precise spatial analysis -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- PapaParse for CSV support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Global State Module -->
    <script src="js/global.js"></script>
    
    <!-- Renderer Configuration -->
    <script src="js/renderer-config.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global variables
        let map;
        let sidebar;
        let layers = new Map();
        let layerCounter = 0;
        let activeFilters = new Map();
        let layerOrder = []; // Array to track layer display order
        
        // Make layers globally accessible for other modules
        window.layers = layers;
        window.layerOrder = layerOrder;
        
        // **CUSTOM MODAL SYSTEM - ALERT, CONFIRM, AND PROMPT**
        
        // Generic modal function
        function showCustomModal(type, message, title, defaultValue = '', okText = 'OK', cancelText = 'Cancel') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const messageEl = document.getElementById('customModalMessage');
                const titleEl = document.getElementById('customModalTitle');
                const iconEl = document.getElementById('customModalIcon');
                const inputContainer = document.getElementById('customModalInput');
                const inputField = document.getElementById('customModalInputField');
                const buttonsContainer = document.getElementById('customModalButtons');
                const okBtn = document.getElementById('customModalOkBtn');
                const cancelBtn = document.getElementById('customModalCancelBtn');
                
                // Set the message and title
                messageEl.textContent = message;
                titleEl.textContent = title;
                
                // Configure modal based on type
                iconEl.className = 'confirm-modal-icon';
                inputContainer.style.display = 'none';
                cancelBtn.style.display = 'none';
                
                switch (type) {
                    case 'alert':
                        iconEl.classList.add('info');
                        iconEl.innerHTML = '<i class="fas fa-info-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'confirm':
                        iconEl.classList.add('question');
                        iconEl.innerHTML = '<i class="fas fa-question-circle"></i>';
                        okBtn.textContent = okText;
                        cancelBtn.textContent = cancelText;
                        cancelBtn.style.display = 'inline-block';
                        break;
                        
                    case 'prompt':
                        iconEl.classList.add('question');
                        iconEl.innerHTML = '<i class="fas fa-edit"></i>';
                        okBtn.textContent = okText;
                        cancelBtn.textContent = cancelText;
                        cancelBtn.style.display = 'inline-block';
                        inputContainer.style.display = 'block';
                        inputField.value = defaultValue || '';
                        inputField.placeholder = 'Enter value...';
                        break;
                        
                    case 'success':
                        iconEl.classList.add('success');
                        iconEl.innerHTML = '<i class="fas fa-check-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'warning':
                        iconEl.classList.add('warning');
                        iconEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                        okBtn.textContent = okText;
                        break;
                        
                    case 'error':
                        iconEl.classList.add('error');
                        iconEl.innerHTML = '<i class="fas fa-times-circle"></i>';
                        okBtn.textContent = okText;
                        break;
                }
                
                // Show the modal
                modal.classList.add('show');
                
                // Focus appropriate element
                setTimeout(() => {
                    if (type === 'prompt') {
                        inputField.focus();
                        inputField.select();
                    } else {
                        okBtn.focus();
                    }
                }, 100);
                
                // Handle button clicks and responses
                const handleOk = () => {
                    // Get the input value BEFORE cleanup
                    const inputValue = (type === 'prompt') ? inputField.value : null;
                    
                    cleanup();
                    
                    switch (type) {
                        case 'alert':
                        case 'success':
                        case 'warning':
                        case 'error':
                            resolve(true);
                            break;
                        case 'confirm':
                            resolve(true);
                            break;
                        case 'prompt':
                            resolve(inputValue);
                            break;
                    }
                };
                
                const handleCancel = () => {
                    cleanup();
                    
                    switch (type) {
                        case 'confirm':
                            resolve(false);
                            break;
                        case 'prompt':
                            resolve(null);
                            break;
                        default:
                            resolve(false);
                            break;
                    }
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleOk();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        if (type === 'alert' || type === 'success' || type === 'warning' || type === 'error') {
                            handleOk();
                        } else {
                            handleCancel();
                        }
                    }
                };
                
                const handleOverlayClick = (e) => {
                    if (e.target === modal) {
                        if (type === 'alert' || type === 'success' || type === 'warning' || type === 'error') {
                            handleOk();
                        } else {
                            handleCancel();
                        }
                    }
                };
                
                const cleanup = () => {
                    // Remove show class first
                    modal.classList.remove('show');
                    
                    // Remove event listeners
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKeydown);
                    modal.removeEventListener('click', handleOverlayClick);
                    
                    // Clear input field
                    inputField.value = '';
                    
                    // Force hide modal with timeout to ensure CSS transition completes
                    setTimeout(() => {
                        modal.style.display = 'none';
                        modal.style.opacity = '0';
                        modal.style.visibility = 'hidden';
                        
                        // Reset styles after hiding
                        setTimeout(() => {
                            modal.style.display = '';
                            modal.style.opacity = '';
                            modal.style.visibility = '';
                        }, 100);
                    }, 300);
                };
                
                // Add event listeners
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleKeydown);
                modal.addEventListener('click', handleOverlayClick);
            });
        }
        
        // Public API functions
        function showAlert(message, title = 'Information') {
            return showCustomModal('alert', message, title);
        }
        
        function showConfirm(message, title = 'Confirm Action') {
            return showCustomModal('confirm', message, title);
        }
        
        function showPrompt(message, defaultValue = '', title = 'Input Required') {
            return showCustomModal('prompt', message, title, defaultValue);
        }
        
        function showSuccess(message, title = 'Success') {
            return showCustomModal('success', message, title);
        }
        
        function showWarning(message, title = 'Warning') {
            return showCustomModal('warning', message, title);
        }
        
        function showError(message, title = 'Error') {
            return showCustomModal('error', message, title);
        }
        
        // showNotification function - maps to existing modal system based on type
        function showNotification(message, type = 'info', duration = 3000) {
            switch (type) {
                case 'success':
                    return showSuccess(message);
                case 'error':
                    return showError(message);
                case 'warning':
                    return showWarning(message);
                case 'info':
                default:
                    return showAlert(message);
            }
        }

        // Make functions globally available
        window.showAlert = showAlert;
        window.showConfirm = showConfirm;
        window.showPrompt = showPrompt;
        window.showSuccess = showSuccess;
        window.showWarning = showWarning;
        window.showError = showError;
        window.showNotification = showNotification;
        
        // Selection tool variables - moved to selection-tools.js module

        // Middle mouse button panning variables
        let isMiddleMouseDown = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Supabase first
            if (!initializeSupabase()) {
                await showError('Failed to connect to Supabase. Some features may not work properly.', 'Connection Error');
                return;
            }
            
            // Check if user is already logged in
            const user = await checkAuthState();
            
            if (user) {
                // User is logged in, show WebGIS interface
                document.getElementById('userEmail').textContent = user.email;
                hideLoginPage();
                initializeWebGIS();
            } else {
                // User not logged in, show login page
                showLoginPage();
                setupLoginListeners();
            }
        });

        // Initialize WebGIS components
        function initializeWebGIS() {
            initializeMap();
            initializeSidebar();
            initializeEventListeners();
            loadInitialData();
        }

        // Initialize the Leaflet map
        function initializeMap() {
            map = L.map('map', {
                center: [14.5995, 120.9842], // Philippines center
                zoom: 6,
                zoomControl: true,
                dragging: true, // Enable normal left-click dragging
                doubleClickZoom: false, // Disable double-click zoom
                boxZoom: false, // Disable Shift+drag zoom box
                scrollWheelZoom: true // Default scroll wheel zoom behavior
            });

            // Initialize basemap system
            initBasemaps(map);

            // Move zoom control to bottom
            map.zoomControl.setPosition('bottomright');
            
            // Initialize selection tools
            initializeSelectionTools(map);
            
            // Add middle mouse button panning functionality
            initializeMiddleMousePanning();
            
            // Add Ctrl+right-click zoom box functionality
            initializeZoomBox(map);
        }

        // Initialize sidebar
        function initializeSidebar() {
            sidebar = L.control.sidebar('sidebar').addTo(map);
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Disable default browser context menu for the entire WebGIS interface
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });

            // Close context menu when clicking anywhere (but preserve context variables for actions)
            document.addEventListener('click', function(e) {
                // Only hide the context menu if clicking outside of it
                const contextMenu = document.getElementById('layerContextMenu');
                if (contextMenu && !contextMenu.contains(e.target)) {
                    hideLayerContextMenu();
                }
            });

            // Modal close listeners (but modals won't be opened from header buttons)
            setupModalListeners();
            
            // File upload listeners for modal (if needed)
            setupFileUploadListeners();
            
            // Symbology listeners
            setupSymbologyListeners();
            
            // Selection tool listeners
            setupSelectionListeners();

            // New comprehensive filter system
            setupNewFilterListeners();

            // Context menu listeners
            setupLayerContextMenuListeners();

            // Logout button listener
            setupLogoutListener();
        }

        // Setup modal event listeners
        function setupModalListeners() {
            // Filter Modal
            document.getElementById('closeFilterModal').addEventListener('click', () => {
                document.getElementById('filterModal').classList.add('hidden');
            });

            // Symbology Modal
            document.getElementById('closeSymbologyModal').addEventListener('click', () => {
                document.getElementById('symbologyModal').classList.add('hidden');
            });
        }

        // Setup file upload listeners
        function setupFileUploadListeners() {
            // Logic moved to add-data.js
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                await showWarning('Please select a file to upload.', 'No File Selected');
                return;
            }

            // Check file size (50MB limit)
            if (file.size > 50 * 1024 * 1024) {
                await showError('File size exceeds 50MB limit.', 'File Too Large');
                return;
            }

            // Check file type
            const validTypes = ['application/json', 'application/geo+json', 'application/vnd.google-earth.kml+xml'];
            const isValidType = validTypes.includes(file.type) || 
                               file.name.toLowerCase().endsWith('.geojson') || 
                               file.name.toLowerCase().endsWith('.json') || 
                               file.name.toLowerCase().endsWith('.kml') ||
                               file.name.toLowerCase().endsWith('.kmz');

            if (!isValidType) {
                await showError('Please upload a valid GeoJSON, KML, or KMZ file.', 'Invalid File Type');
                return;
            }

            showUploadProgress();

        // Logic moved to add-data.js

            // Handle middle mouse button down - start custom panning
            mapContainer.addEventListener('mousedown', function(e) {
                if (e.button === 1) { // Middle mouse button
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isMiddleMouseDown = true;
                    isDraggingWithMiddle = false;
                    startPoint = { x: e.clientX, y: e.clientY };
                    
                    // Change cursor to indicate panning mode
                    mapContainer.style.cursor = 'grab';
                }
            });

            // Handle mouse move for middle button panning
            mapContainer.addEventListener('mousemove', function(e) {
                if (isMiddleMouseDown && startPoint) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!isDraggingWithMiddle) {
                        // Start dragging - change cursor to grabbing
                        mapContainer.style.cursor = 'grabbing';
                        isDraggingWithMiddle = true;
                    }
                    
                    // Calculate movement delta
                    const deltaX = e.clientX - startPoint.x;
                    const deltaY = e.clientY - startPoint.y;
                    
                    // Only pan if there's significant movement to avoid jitter
                    if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
                        // Get current map center
                        const currentCenter = map.getCenter();
                        
                        // Convert pixel movement to lat/lng movement
                        const pixelBounds = map.getPixelBounds();
                        const pixelOrigin = map.getPixelOrigin();
                        
                        // Calculate new center based on pixel movement
                        const currentPixel = map.latLngToContainerPoint(currentCenter);
                        const newPixel = L.point(currentPixel.x - deltaX, currentPixel.y - deltaY);
                        const newCenter = map.containerPointToLatLng(newPixel);
                        
                        // Pan to new center
                        map.panTo(newCenter, { animate: false });
                        
                        // Update start point for next movement
                        startPoint = { x: e.clientX, y: e.clientY };
                    }
                }
            });

            // Handle middle mouse button up - stop custom panning
            mapContainer.addEventListener('mouseup', function(e) {
                if (e.button === 1 && isMiddleMouseDown) { // Middle mouse button
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isMiddleMouseDown = false;
                    isDraggingWithMiddle = false;
                    startPoint = null;
                    
                    // Restore appropriate cursor based on current tool
                    if (isSelectionActive) {
                        mapContainer.style.cursor = 'crosshair';
                    } else {
                        mapContainer.style.cursor = '';
                    }
                }
            });

            // Handle mouse leave - stop panning if middle button was held
            mapContainer.addEventListener('mouseleave', function(e) {
                if (isMiddleMouseDown) {
                    isMiddleMouseDown = false;
                    isDraggingWithMiddle = false;
                    startPoint = null;
                    
                    // Restore appropriate cursor
                    if (isSelectionActive) {
                        mapContainer.style.cursor = 'crosshair';
                    } else {
                        mapContainer.style.cursor = '';
                    }
                }
            });

            // Prevent middle button from interfering with other mouse events
            mapContainer.addEventListener('click', function(e) {
                if (e.button === 1) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        }

        // Initialize Ctrl+Right-Click Zoom Box functionality
        function initializeZoomBox(mapInstance) {
            const mapContainer = mapInstance.getContainer();
            let isZoomBoxActive = false;
            let startPoint = null;
            let zoomBox = null;
            
            // Create zoom box element
            function createZoomBox() {
                const box = document.createElement('div');
                box.style.position = 'absolute';
                box.style.border = '2px dashed #0078d4';
                box.style.backgroundColor = 'rgba(0, 120, 212, 0.1)';
                box.style.pointerEvents = 'none';
                box.style.zIndex = '1000';
                box.style.display = 'none';
                mapContainer.appendChild(box);
                return box;
            }
            
            // Initialize zoom box element
            zoomBox = createZoomBox();
            
            // Handle right mouse button down with Ctrl
            mapContainer.addEventListener('mousedown', function(e) {
                // Only activate on right mouse button (2) with Ctrl key
                if (e.button === 2 && e.ctrlKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isZoomBoxActive = true;
                    startPoint = { x: e.clientX, y: e.clientY };
                    
                    // Get container offset for positioning
                    const rect = mapContainer.getBoundingClientRect();
                    const containerX = e.clientX - rect.left;
                    const containerY = e.clientY - rect.top;
                    
                    // Position zoom box at mouse location
                    zoomBox.style.left = containerX + 'px';
                    zoomBox.style.top = containerY + 'px';
                    zoomBox.style.width = '0px';
                    zoomBox.style.height = '0px';
                    zoomBox.style.display = 'block';
                    
                    // Disable map dragging during zoom box operation
                    mapInstance.dragging.disable();
                    
                    // Change cursor to crosshair
                    mapContainer.style.cursor = 'crosshair';
                }
            });
            
            // Handle mouse move for zoom box drawing
            mapContainer.addEventListener('mousemove', function(e) {
                if (isZoomBoxActive && startPoint) {
                    e.preventDefault();
                    
                    const rect = mapContainer.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    const startX = startPoint.x - rect.left;
                    const startY = startPoint.y - rect.top;
                    
                    // Calculate box dimensions
                    const left = Math.min(startX, currentX);
                    const top = Math.min(startY, currentY);
                    const width = Math.abs(currentX - startX);
                    const height = Math.abs(currentY - startY);
                    
                    // Update zoom box position and size
                    zoomBox.style.left = left + 'px';
                    zoomBox.style.top = top + 'px';
                    zoomBox.style.width = width + 'px';
                    zoomBox.style.height = height + 'px';
                }
            });
            
            // Handle right mouse button up - complete zoom box
            mapContainer.addEventListener('mouseup', function(e) {
                if (e.button === 2 && isZoomBoxActive) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const rect = mapContainer.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    const startX = startPoint.x - rect.left;
                    const startY = startPoint.y - rect.top;
                    
                    // Calculate minimum box size (prevent accidental tiny zooms)
                    const minBoxSize = 10;
                    const width = Math.abs(endX - startX);
                    const height = Math.abs(endY - startY);
                    
                    if (width > minBoxSize && height > minBoxSize) {
                        // Convert screen coordinates to map coordinates
                        const corner1 = mapInstance.containerPointToLatLng([startX, startY]);
                        const corner2 = mapInstance.containerPointToLatLng([endX, endY]);
                        
                        // Create bounds from the two corners
                        const bounds = L.latLngBounds([corner1, corner2]);
                        
                        // Zoom to the drawn rectangle with smooth animation
                        mapInstance.fitBounds(bounds, {
                            animate: true,
                            duration: 0.5,
                            padding: [5, 5] // Small padding for better visual appearance
                        });
                    }
                    
                    // Clean up
                    isZoomBoxActive = false;
                    startPoint = null;
                    zoomBox.style.display = 'none';
                    
                    // Re-enable map dragging
                    mapInstance.dragging.enable();
                    
                    // Reset cursor
                    mapContainer.style.cursor = '';
                }
            });
            
            // Handle context menu prevention during zoom box operation
            mapContainer.addEventListener('contextmenu', function(e) {
                if (e.ctrlKey || isZoomBoxActive) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // Clean up on mouse leave
            mapContainer.addEventListener('mouseleave', function(e) {
                if (isZoomBoxActive) {
                    isZoomBoxActive = false;
                    startPoint = null;
                    zoomBox.style.display = 'none';
                    mapInstance.dragging.enable();
                    mapContainer.style.cursor = '';
                }
            });
        }

    </script>
    <script src="js/add-data.js"></script>
    <script src="js/map-print.js"></script>

    <!-- Print Layout Modal -->
    <div id="printLayoutModal" class="fixed inset-0 z-[9999] bg-black/70 flex items-center justify-center hidden">
        <div class="bg-[#0f172a] w-[90%] h-[90%] rounded-lg shadow-md p-4 flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center text-white font-semibold text-lg mb-4">
                <div class="flex items-center">
                    <i class="fas fa-print mr-2"></i>
                    Print Layout Editor
                </div>
                <button id="closePrintLayoutModal" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <!-- Main Content -->
            <div class="flex-grow flex gap-4">
                <!-- Map Preview -->
                <div class="w-[75%] h-full rounded overflow-hidden border border-gray-700 bg-gray-800">
                    <div id="printMapContainer" class="w-full h-full"></div>
                </div>
                
                <!-- Control Panel -->
                <div class="w-[25%] flex flex-col gap-4">
                    <!-- Print Settings -->
                    <div class="glass-panel rounded-lg p-4">
                        <h3 class="text-white font-semibold text-sm mb-3">
                            <i class="fas fa-cog mr-2"></i>Print Settings
                        </h3>
                        
                        <!-- Page Size -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Page Size</label>
                            <select id="printPageSize" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm">
                                <option value="A4Landscape">A4 Landscape</option>
                                <option value="A4Portrait">A4 Portrait</option>
                            </select>
                        </div>
                        
                        <!-- Quality -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Quality</label>
                            <select id="printQuality" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white text-sm">
                                <option value="high">High (300 DPI)</option>
                                <option value="medium">Medium (150 DPI)</option>
                                <option value="low">Low (96 DPI)</option>
                            </select>
                        </div>
                        
                        <!-- Include Legend -->
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="includeLegend" class="form-checkbox h-4 w-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
                            <label class="ml-2 text-sm text-gray-300">Include Legend</label>
                        </div>
                    </div>
                    
                    <!-- Export Button -->
                    <button id="exportPrintLayout" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors text-sm font-medium flex items-center justify-center">
                        <i class="fas fa-file-export mr-2"></i>Export as PNG
                    </button>
                    
                    <!-- Help Text -->
                    <div class="text-xs text-gray-400">
                        <p class="mb-2"><i class="fas fa-mouse-pointer mr-1"></i>Pan and zoom the map to adjust the print area</p>
                        <p><i class="fas fa-info-circle mr-1"></i>Only visible layers will be included in the export</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

